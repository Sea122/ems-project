{% extends "layout.html" %}

{% block header_title %}Command Center{% endblock %}

{% block content %}
<div class="space-y-8">
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-gradient-to-br from-indigo-600 to-indigo-800 rounded-xl p-8 text-white shadow-lg relative overflow-hidden transition transform hover:scale-105 duration-300">
            <div class="relative z-10">
                <div class="text-indigo-200 text-sm uppercase font-bold tracking-wider">Total Workforce</div>
                <div class="text-5xl font-bold mt-3">{{ stats.total_emp }}</div>
                <div class="text-indigo-300 text-sm mt-2"><i class="fas fa-check-circle"></i> All Active</div>
            </div>
            <i class="fas fa-users absolute -bottom-6 -right-6 text-9xl text-indigo-500 opacity-20"></i>
        </div>
        
        <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-100 flex flex-col justify-between transition transform hover:scale-105 duration-300">
            <div>
                <div class="text-gray-400 text-sm uppercase font-bold tracking-wider">Active Projects</div>
                <div class="text-5xl font-bold text-gray-800 mt-3">{{ stats.active_projects }}</div>
            </div>
            <div class="text-green-500 text-sm font-bold mt-4 flex items-center">
                <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span> System Online
            </div>
        </div>

        <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-100 cursor-pointer hover:bg-purple-50 transition border-dashed border-2 border-purple-200 group" onclick="toggleModal('announceModal')">
            <div class="flex flex-col items-center justify-center h-full text-purple-600 font-bold group-hover:text-purple-700">
                <div class="bg-purple-100 p-4 rounded-full mb-3 group-hover:bg-purple-200 transition">
                    <i class="fas fa-bullhorn text-3xl"></i>
                </div>
                <span class="text-lg">Post New Notice</span>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="px-8 py-5 border-b bg-gray-50 flex justify-between items-center">
            <h3 class="font-bold text-gray-700 text-lg"><i class="fas fa-newspaper mr-2"></i> Official Announcements</h3>
            {% if user.role == 'Head of Department' %}
            <button onclick="toggleModal('announceModal')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 shadow-sm text-sm font-bold flex items-center transition">
                <i class="fas fa-plus mr-2"></i> Add Notice
            </button>
            {% endif %}
        </div>
        
        <div class="p-8 space-y-8">
            {% for notice in announcements %}
            <div class="relative pl-6 border-l-4 border-indigo-500 bg-gray-50 p-6 rounded-r-xl">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="text-xs text-indigo-500 font-bold uppercase mb-2 tracking-wide">{{ notice.date }}</div>
                        <h4 class="text-xl font-bold text-gray-800 mb-2">{{ notice.title }}</h4>
                        <p class="text-gray-600 text-base leading-relaxed whitespace-pre-line">{{ notice.content }}</p>
                    </div>
                    
                    {% if user.role == 'Head of Department' %}
                    <div class="flex space-x-2 ml-4">
                        <button onclick="openEditAnnounceModal('{{ notice.id }}', '{{ notice.title }}', '{{ notice.content }}')" class="p-2 text-blue-600 hover:bg-blue-100 rounded-full transition" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <a href="/delete_announcement/{{ notice.id }}" onclick="return confirm('Delete this announcement?')" class="p-2 text-red-600 hover:bg-red-100 rounded-full transition" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            
            {% if announcements|length == 0 %}
            <div class="text-center text-gray-400 py-10">
                <i class="fas fa-inbox text-4xl mb-3"></i>
                <p>No announcements yet.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div id="announceModal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-md p-8 shadow-2xl transform transition-all">
        <h3 class="text-xl font-bold mb-6 text-gray-800">Post Announcement</h3>
        <form action="/add_announcement" method="POST" class="space-y-5">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Topic Header</label>
                <input type="text" name="title" required class="w-full border border-gray-300 p-3 rounded-lg font-bold focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Message Detail</label>
                <textarea name="content" required class="w-full border border-gray-300 p-3 rounded-lg h-32 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition"></textarea>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="toggleModal('announceModal')" class="bg-gray-100 text-gray-700 px-5 py-2.5 rounded-lg hover:bg-gray-200 transition font-medium">Cancel</button>
                <button type="submit" class="bg-purple-600 text-white px-5 py-2.5 rounded-lg hover:bg-purple-700 shadow-lg transition font-medium transform hover:-translate-y-0.5">Post Now</button>
            </div>
        </form>
    </div>
</div>

<div id="editAnnounceModal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-md p-8 shadow-2xl border-t-8 border-purple-500">
        <h3 class="text-xl font-bold mb-6 text-gray-800">Edit Announcement</h3>
        <form action="/edit_announcement" method="POST" class="space-y-5">
            <input type="hidden" id="edit_ann_id" name="ann_id">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Topic Header</label>
                <input type="text" id="edit_ann_title" name="title" required class="w-full border border-gray-300 p-3 rounded-lg font-bold focus:ring-2 focus:ring-purple-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Message Detail</label>
                <textarea id="edit_ann_content" name="content" required class="w-full border border-gray-300 p-3 rounded-lg h-32 focus:ring-2 focus:ring-purple-500 outline-none"></textarea>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="toggleModal('editAnnounceModal')" class="bg-gray-100 text-gray-700 px-5 py-2.5 rounded-lg hover:bg-gray-200 transition font-medium">Cancel</button>
                <button type="submit" class="bg-purple-600 text-white px-5 py-2.5 rounded-lg hover:bg-purple-700 shadow-lg transition font-medium">Save Changes</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function openEditAnnounceModal(id, title, content) {
        // จัดการเรื่องการเว้นบรรทัด (Newline) เวลาส่งเข้า JS
        content = content.replace(/(\r\n|\n|\r)/gm, "\\n");
        document.getElementById('edit_ann_id').value = id;
        document.getElementById('edit_ann_title').value = title;
        document.getElementById('edit_ann_content').value = content;
        toggleModal('editAnnounceModal');
    }
</script>
{% endblock %}
